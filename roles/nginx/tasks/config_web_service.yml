---
    # at this point, we know webserver_dns

    - name: link ssl cert to correct file
      file:
        src: "{{ nginx_ssl_dest_dir }}/{{ webserver_dns | replace('.', '_') }}_bundle.crt"
        dest: "{{ nginx_ssl_dest_dir }}/{{ service_name }}.crt"
        state: link
      when: enable_ssl == 'true'
      notify: restart nginx


    - name: link ssl key to correct file
      file:
        src: "{{ nginx_ssl_dest_dir }}/{{ webserver_dns | replace('.', '_') }}.key"
        dest: "{{ nginx_ssl_dest_dir }}/{{ service_name }}.key"
        state: link
      when: enable_ssl == 'true'
      notify: restart nginx


    - name: replace server_name with webserver_dns in nginx config
      replace:
        path: /etc/nginx/sites-available/{{ service_name }}
        regexp: "CATCHPY_WEBSERVER_DNS"
        replace: "{{ webserver_dns }}"
        backup: yes
      when: enable_ssl == 'true'


    - name: replace server_name with webserver_dns in nonssl nginx config
      replace:
        path: /etc/nginx/sites-available/nonssl_{{ service_name }}
        regexp: "CATCHPY_WEBSERVER_DNS"
        replace: "{{ webserver_dns }}"
        backup: yes


    - name: ensure service site is enabled
      file:
        src: /etc/nginx/sites-available/{{ (enable_ssl == true) | ternary('', 'nonssl_') }}{{ service_name }}
        dest: /etc/nginx/sites-enabled/{{ service_name }}
        state: link
      notify: restart nginx

